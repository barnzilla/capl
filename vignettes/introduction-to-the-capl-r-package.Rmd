---
title: "Introduction to the `capl` R package"
author: "Joel D. Barnes, M.Sc. and Michelle D. Guerrero, Ph.D."
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 4
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Introduction to the `capl` R package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<style>
  img { border: 0;}
  p { margin-top: 1rem;line-height: 1.5rem; }
  a, a:visited { color: #00a79d; }
  a:hover { color: #333376; }
</style>

<img src="img/capl-2-logo-bilingual.jpg" style = "height: 78px; max-height: 78px; width: auto; margin-top: 48px; margin-bottom: 24px; border: 0;" alt="logo">

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c("top", "right"))
```

## Introduction

<a href="https://www.capl-eclp.ca" target="_blank">The Canadian Assessment of Physical Literacy (CAPL)</a> is the first comprehensive protocol that can accurately and reliably assess a broad spectrum of skills and abilities that contribute to and characterize the physical literacy level of a participating child.

Physical literacy moves beyond just fitness, motor skill or motivation in isolation. The CAPL is unique in that it can assess the multiple aspects of physical literacy: daily behaviour, motivation & confidence, knowledge & understanding, and physical competence.

The domains of physical literacy are nicely summarized in figure 1 of <a href="https://www.capl-eclp.ca/wp-content/uploads/2017/10/capl-2-manual-en.pdf" target="_blank">the CAPL-2 manual</a> on page 6:

<img src="img/domains-of-physical-literacy.jpg" alt="domains of physical literacy" style="width: 75%; height: auto; display: block; margin-left: auto; margin-right: auto;">

<a href="https://www.haloresearch.ca" target="_blank">The Healthy Active Living and Obesity Research Group (HALO)</a> have been responsible for the systematic development of the CAPL since 2008. HALOâ€™s test development efforts have been informed by the assessment of more than 10,000 children and with input from well over 100 researchers and practitioners within related fields of study.

The `capl` R package contains tools that enables users to compute CAPL-2 (Canadian Assessment of Physical Literacy, Second Edition) scores and interpretations from raw data, and to visualize results, all within the R environment without having to use the <a href="https://www.capl-eclp.ca" target="_blank">CAPL-2 website</a>.

## Installation
### Source package

Users can download and install the source package by calling the `install.packages()` function from the `utils` R package, which comes pre-installed with R.

```{r warning = FALSE, message = FALSE, eval = FALSE}
utils::install.packages(
  pkgs = "https://github.com/barnzilla/r-package-sources/raw/master/capl_1.0.tar.gz",
  repos = NULL, 
  type = "source"
)
library(capl)
```

### GitHub

The most recent version of the `capl` R package is also available on GitHub: <a href="https://github.com/barnzilla/capl" target="_blank">www.github.com/barnzilla/capl</a>. The `devtools` R package allows users to download and install the `capl` R package directly from GitHub.

```{r warning = FALSE, message = FALSE, eval = FALSE}
devtools::install_github("barnzilla/capl", upgrade = "never", build_vignettes = TRUE, force = TRUE)
library(capl)
```

```{r warning = FALSE, message = FALSE, echo = FALSE}
library(capl)
```

Once the `capl` R package is loaded, any available tutorials for the package, such as this vignette, can be accessed by calling the `browseVignettes()` function.

```{r warning = FALSE, message = FALSE, eval = FALSE}
browseVignettes("capl")
```

## Getting started

Before using the `capl` R package, users must first import raw data. 

<a name="required-variables"></a>

### Required variables

The `capl` R package requires 60 variables in order to compute CAPL-2 scores and interpretations. If users look up the documentation for the `get_missing_capl_variables()` function, they will find a list of all 60 required variables in the Details section of the documentation.

```{r warning = FALSE, message = FALSE, eval = FALSE}
?get_missing_capl_variables()
```

The `capl` R package is looking for 60 variables by the following names:

* `age`
* `gender`
* `pacer_lap_distance`
* `pacer_laps`
* `plank_time`
* `camsa_skill_score1`
* `camsa_time1`
* `camsa_skill_score2`
* `camsa_time2`
* `steps1`
* `time_on1`
* `time_off1`
* `non_wear_time1`
* `steps2`
* `time_on2`
* `time_off2`
* `non_wear_time2`
* `steps3`
* `time_on3`
* `time_off3`
* `non_wear_time3`
* `steps4`
* `time_on4`
* `time_off4`
* `non_wear_time4`
* `steps5`
* `time_on5`
* `time_off5`
* `non_wear_time5`
* `steps6`
* `time_on6`
* `time_off6`
* `non_wear_time6`
* `steps7`
* `time_on7`
* `time_off7`
* `non_wear_time7`
* `self_report_pa`
* `csappa1`
* `csappa2`
* `csappa3`
* `csappa4`
* `csappa5`
* `csappa6`
* `why_are_you_active1`
* `why_are_you_active2`
* `why_are_you_active3`
* `feelings_about_pa1`
* `feelings_about_pa2`
* `feelings_about_pa3`
* `pa_guideline`
* `cardiorespiratory_fitness_means`
* `muscular_strength_means`
* `sports_skill`
* `pa_is`
* `pa_is_also`
* `improve`
* `increase`
* `when_cooling_down`
* `heart_rate`

### Loading the pre-installed dataset

The `capl` R package comes with a demo (fake) dataset of raw data, `capl_demo_data`, that can be loaded and which allows users to quickly start exploring. This dataset contains 500 rows of participant data on <a href="#required-variables">the 60 variables</a> that are required by the `capl` R package.

```{r warning = FALSE, message = FALSE}
data(capl_demo_data)
```

Calling the `str()` function on the `capl_demo_data` object allows users to get a sense of how CAPL-2 raw data must be structured -- and named -- for upstream use in the `capl` R package.

```{r warning = FALSE, message = FALSE}
str(capl_demo_data)
```

<a href="#required-variables">The 60 required variables</a> can also be quickly accessed by calling the `colnames()` function.

```{r warning = FALSE, message = FALSE}
colnames(capl_demo_data)
```


### Generating demo raw data

The `capl` R package also comes with a function, `get_capl_demo_data()`, that allows users to randomly generate demo raw data on the fly. The function takes one argument, `n` (set to 500 by default), which must be an integer and greater than 0, and which tells the function how many rows of demo raw data to randomly generate. For example, users can randomly generate demo raw data for 10,000 participants by executing a single line of code.

```{r warning = FALSE, message = FALSE}
capl_demo_data2 <- get_capl_demo_data(n = 10000)
```

The `str()` function can be called to verify how many rows and columns of data were created.

```{r warning = FALSE, message = FALSE}
str(capl_demo_data2)
```

### Exporting data to Excel

If users prefer to examine the CAPL demo raw data in a spreadsheet, the `writexl` R package allows them to export data objects to Excel.

First, users must install the `writexl` R package if they haven't done so previously.

```{r warning = FALSE, message = FALSE, eval = FALSE}
# Install the package
install.packages("writexl")
```

Then, they must load the package and call the `write_xlsx()` function.

```{r warning = FALSE, message = FALSE, eval = FALSE}
# Load the package
library(writexl)

# Export object to Excel
write_xlsx(capl_demo_data2, "c:/users/joel/desktop/capl_demo_data2.xlsx")
```

### Renaming variables

If users have imported their own raw data and need to rename variables so they match <a href="#required-variables">the 60 variables</a>, they can do so by calling the `rename_variable()` function. This function has three arguments: the `x` argument must be set to the raw data object. The `search` argument must be set to a character vector representing the variable name(s) to be renamed, and the `replace` argument must be set to a character vector representing the new names for the variables specified in the `search` argument.

```{r}
# Create fake data
raw_data <- data.frame(
  age_years = sample(8:12, 100, replace = TRUE),
  genders = sample(c("girl", "boy"), 100, replace = TRUE, prob = c(0.51, 0.49)),
  step_counts1 = sample(1000:30000, 100, replace = TRUE),
  step_counts2 = sample(1000:30000, 100, replace = TRUE),
  step_counts3 = sample(1000:30000, 100, replace = TRUE),
  step_counts4 = sample(1000:30000, 100, replace = TRUE),
  step_counts5 = sample(1000:30000, 100, replace = TRUE),
  step_counts6 = sample(1000:30000, 100, replace = TRUE),
  step_counts7 = sample(1000:30000, 100, replace = TRUE)
)

# Examine the structure of this data
str(raw_data)

# Rename the variables
raw_data <- rename_variable(
  x = raw_data,
  search = colnames(raw_data),
  replace = c("age", "gender", "steps1", "steps2", "steps3", "steps4", "steps5", "steps6", "steps7")
)

# Examine the structure of this data
str(raw_data)
```

<a name="validation"></a>

### Validation vs. nosiy errors

One of the coding philosophies behind the `capl` R package is to return NA values rather than to be "noisy" and throw errors when data is missing or invalid. In order to implement this approach, every `capl` function involves validation of data.

#### Validation of age

For example, the Canadian Asssessment of Physical Literacy is currently valid for 8- to 12-year-old children. When a function requires the `age` variable in order to execute a computation (e.g., `get_capl_interpretation()`), the `age` variable is validated via the `validate_age()` function.

```{r}
validated_age <- validate_age(c(7, 8, 9, 10, 11, 12, 13, "", NA, "12", 8.5))
```

Notice the NA values in the results.

```{r}
validated_age
```

The first element is NA because the original value is 7. The next five elements are identical to their original values because they are integers between 8 and 12. The seventh element is NA because the original value is 13. The next two elements are NA because the original values ("" and NA) are obviously invalid. The last element is 8, but notice that the original value is a decimal. Because 8.5 is between 8 and 12, it is considered valid but the floor of the value is returned since CAPL performs age-specific computations based on integer age.

#### Validation of gender

The Canadian Asssessment of Physical Literacy is currently valid for children who identify as boys or girls. When a function requires the `gener` variable in order to execute a computation (e.g., `get_capl_interpretation()`), the `gender` variable is validated via the `validate_gender()` function.

```{r}
validated_gender <- validate_gender(c("Girl", "GIRL", "g", "G", "Female", "f", "F", "", NA, 1))
```

Notice the results.

```{r}
validated_gender
```

This function accepts a number of case-insensitive options (e.g., "Girl", "G", "Female", "F", 1) for the female gender and returns a standardized "girl" value. The only two elements that are returned as NA have original values that are obviously invalid ("" and NA).

```{r}
validated_gender <- validate_gender(c("Boy", "BOY", "b", "B", "Male", "m", "M", "", NA, 0))
```

Notice the results again.

```{r}
validated_gender
```

This function also accepts a number of case-insensitive options (e.g., "Boy", "B", "Male", "M", 0) for the male gender and returns a standardized "boy" value. The only two elements that are returned as NA have original values that are obviously invalid ("" and NA).

#### Validation functions in the capl R package

There are eight validation functions included in the `capl` R package to help provide a "quiet" user experience:

* `validate_age()`
* `validate_character()`
* `validate_domain_score()`
* `validate_gender()`
* `validate_integer()`
* `validate_number()`
* `validate_scale()`
* `validate_steps()`

Users can learn more about these functions by accessing the documentation within the R environment.

```{r eval = FALSE}
?validate_age
?validate_character
?validate_domain_score
?validate_gender
?validate_integer
?validate_number
?validate_scale
?validate_steps
```

## Computing CAPL-2 scores and interpretations

The CAPL-2 scoring system is nicely summarized in figure 2 of <a href="https://www.capl-eclp.ca/wp-content/uploads/2017/10/capl-2-manual-en.pdf" target="_blank">the CAPL-2 manual</a> on page 7:

<img src="img/capl-2-comprehensive-scoring-system.jpg" style="width: 100%; height: auto;" alt="capl 2 comprehensive scoring system">

The main function in the `capl` R package is the `get_capl()` function. This function takes two arguments, `raw_data` and `sort` and tries to compute the CAPL-2 scores in figure 2 above and their associated age- and gender-specific interpretations, row by row, by calling the other functions in the `capl` R package. 

The `raw_data` argument must be structured as a data frame and contain the raw data. The `sort` argument is set to "asis" by default. This means the 40 new variables will be added to the data frame as they are computed. If `sort` is set to "abc", all variables will be sorted alphabetically whereas if `sort` is set to "zyx", all variables will be sorted in reverse alphabetical order.

One of the coding philosophies behind the `capl` R package is <a href="#validation">validation</a>, that is, to return NA values rather than to be "noisy" and throw errors when data is missing or invalid. So, if any of <a href="#required-variables">the 60 required variables</a> are missing, for example, the `get_capl()` function will still execute without throwing errors. It will call the `get_missing_capl_variables()` function and create any missing variables that are required and populate these variables with NA values.

Computing the CAPL-2 scores and interpretations is as simple as executing one line of code once the raw data has been imported. This function may take some time to fully execute depending on how many rows of data are in the `raw_data` data frame.

```{r warning = FALSE, message = FALSE}
capl_results <- get_capl(raw_data = capl_demo_data, sort = "abc")
```

The addition of the 40 variables related to/including the CAPL-2 scores and interpretations can be confirmed by calling the `str()` function. There are now 500 rows of participant data on 100 variables.

```{r}
str(capl_results, list.len = nrow(capl_results))
```

Some users may want to validate and compute individual variables and scores. The next several sections introduce the functions by domain that are called in the `get_capl()` function.

### Physical competence functions

As illustrated in <a href="https://www.capl-eclp.ca/wp-content/uploads/2017/10/capl-2-manual-en.pdf" target="_blank">the CAPL-2 manual</a> on page 43, the formula for computing the physical competence score is:

<img src="img/physical-competence-formula.jpg" alt="physical competence formula" style="width: 100%; height: auto;">

#### PACER 20-metre laps

The `pacer_laps_20m()` function converts PACER (Progressive Aerobic Cardiovascular Endurance Run) shuttle run laps to their equivalent in 20-metre laps. If laps are already 20-metre laps, they are returned unless outside the valid range (1-229). This variable is used to compute the PACER score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$pacer_laps_20m <- get_pacer_20m_laps(
  lap_distance = capl_demo_data$pacer_lap_distance, 
  laps_run = capl_demo_data$pacer_laps
)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$pacer_laps_20m
```

#### PACER score

The `get_pacer_score()` function computes a PACER (Progressive Aerobic Cardiovascular Endurance Run) score based on the number of PACER laps run at a 20-metre distance. This score is used to compute the physical competence domain score variable.

```{r warning = FALSE, message = FALSE}
capl_demo_data$pacer_score <- get_pacer_score(capl_demo_data$pacer_laps_20m)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$pacer_score
```

#### PACER interpretation

The `get_capl_interpretation()` function computes an age- and gender-specific CAPL-2 interpretation for a given CAPL-2 protocol or domain score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$pacer_interpretation <- get_capl_interpretation(
  age = capl_demo_data$age,
  gender = capl_demo_data$gender,
  score = capl_demo_data$pacer_score,
  protocol = "pacer"
)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$pacer_interpretation
```

#### Plank score

The `get_plank_score()` function computes a plank score based on the duration of time (in seconds) for which a plank is held. This score is used to compute the physical competence domain score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$plank_score <- get_plank_score(capl_demo_data$plank_time)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$plank_score
```

#### Plank interpretation

The `get_capl_interpretation()` function computes an age- and gender-specific CAPL-2 interpretation for a given CAPL-2 protocol or domain score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$plank_interpretation <- get_capl_interpretation(
  age = capl_demo_data$age,
  gender = capl_demo_data$gender,
  score = capl_demo_data$plank_time,
  protocol = "plank"
)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$plank_interpretation
```

#### CAMSA time score

The `get_camsa_time()` function computes the CAMSA (Canadian Agility and Movement Skill Assessment) time score based on the time taken (in seconds) to complete a trial.

```{r warning = FALSE, message = FALSE}
# Trial 1
capl_demo_data$camsa_time_score1 <- get_camsa_time_score(capl_demo_data$camsa_time1)

# Trial 2
capl_demo_data$camsa_time_score2 <- get_camsa_time_score(capl_demo_data$camsa_time2)
```

```{r warning = FALSE, message = FALSE}
# Time scores for trial 1
capl_demo_data$camsa_time_score1
```

```{r warning = FALSE, message = FALSE}
# Time scores for trial 2
capl_demo_data$camsa_time_score2
```

#### CAMSA skill + time score

The `get_camsa_trial_score()` function computes the CAMSA (Canadian Agility and Movement Skill Assessment) skill + time score for a given trial. This score is used to compute the CAMSA overall score.

```{r warning = FALSE, message = FALSE}
# Trial 1
capl_demo_data$camsa_score1 <- get_camsa_trial_score(
  camsa_skill_score = capl_demo_data$camsa_skill_score1,
  camsa_time_score = capl_demo_data$camsa_time_score1
)

# Trial 2
capl_demo_data$camsa_score2 <- get_camsa_trial_score(
  camsa_skill_score = capl_demo_data$camsa_skill_score2,
  camsa_time_score = capl_demo_data$camsa_time_score2
)
```

```{r warning = FALSE, message = FALSE}
# Time scores for trial 1
capl_demo_data$camsa_score1
```

```{r warning = FALSE, message = FALSE}
# Time scores for trial 2
capl_demo_data$camsa_score2
```

#### CAMSA overall score

The `get_camsa_overall_score()` function computes the maximum CAMSA (Canadian Agility and Movement Skill Assessment) skill + time score for two trials and then divides by 2.8 so that the score is out of 10. This score is used to compute the physical literacy score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$camsa_overall_score <- get_camsa_overall_score(
  camsa_score1 = capl_demo_data$camsa_score1,
  camsa_score2 = capl_demo_data$camsa_score2
)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$camsa_overall_score
```

#### CAMSA interpretation

The `get_capl_interpretation()` function computes an age- and gender-specific CAPL-2 interpretation for a given CAPL-2 protocol or domain score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$camsa_interpretation <- get_capl_interpretation(
  age = capl_demo_data$age,
  gender = capl_demo_data$gender,
  score = capl_demo_data$camsa_overall_score,
  protocol = "camsa"
)

j <- function(age = NA, gender = NA, score = NA, protocol = NA) {
  try(
    if(var(c(length(age), length(gender), length(score))) == 0) {
      pacer_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(10, 25, 37, 37, 9, 19, 27, 27, 10, 27, 39, 39, 10, 21, 29, 29, 11, 28, 41, 41, 10, 21, 30, 30, 11, 30, 43, 43, 11, 23, 32, 32, 13, 33, 48, 48, 12, 26, 36, 36),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      plank_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(12.4, 72.0, 101.0, 101.0, 24.4, 59.4, 89.3, 89.3, 15.2, 74.9, 103.8, 103.8, 25.2, 61.4, 92.2, 92.2, 18.1, 77.7, 106.7, 106.7, 26.0, 63.4, 95.2, 95.2, 20.9, 80.6, 109.5, 109.5, 26.8, 65.3, 98.2, 98.2, 23.8, 83.4, 112.4, 112.4, 27.6, 67.3, 101.2, 101.2),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      camsa_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(16, 21, 23, 23, 15, 20, 21, 21, 17, 22, 23, 23, 16, 21, 22, 22, 17, 22, 24, 24, 17, 22, 23, 23, 18, 23, 25, 25, 17, 22, 24, 24, 18, 24, 26, 26, 18, 23, 25, 25),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      pc_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(13.4, 19.4, 22.0, 22.0, 13.2, 18.0, 20.3, 20.3, 13.7, 19.9, 22.5, 22.5, 13.7, 18.6, 20.9, 20.9, 14.0, 20.3, 23.0, 23.0, 14.1, 19.1, 21.6, 21.6, 14.3, 20.8, 23.6, 23.6, 14.5, 19.8, 22.3, 22.3, 14.9, 21.6, 24.5, 24.5, 15.2, 20.7, 23.3, 23.3),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      steps_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(8892, 11999, 17980, 17980, 8059, 11999, 15643, 15643, 8655, 11999, 17500, 17500, 7814, 11999, 15168, 15168, 8417, 11999, 17020, 17020, 7569, 11999, 14692, 14692, 8180, 11999, 16539, 16539, 7324, 11999, 14217, 14217, 7942, 11999, 16059, 16059, 7079, 11999, 13742, 13742),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      self_report_pa_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(4, 4, 6, 6, 4, 4, 6, 6, 4, 4, 6, 6, 3, 4, 6, 6, 4, 4, 6, 6, 3, 4, 6, 6, 4, 4, 6, 6, 3, 4, 6, 6, 4, 4, 6, 6, 3, 4, 6, 6),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      db_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(8.8, 22.3, 26.9, 26.9, 10.8, 21.6, 26.2, 26.2, 8.8, 22.3, 26.9, 26.9, 10.7, 21.5, 26.1, 26.1, 8.8, 22.3, 26.9, 26.9, 10.5, 21.1, 25.7, 25.7, 8.8, 22.3, 26.9, 26.9, 10.1, 20.4, 24.8, 24.8, 8.8, 22.3, 26.9, 26.9, 10.1, 20.3, 24.7, 24.7),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      mc_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(16.3, 23.0, 25.3, 25.3, 16.2, 22.3, 24.8, 24.8, 16.7, 23.3, 25.7, 25.7, 16.2, 22.3, 24.8, 24.8, 16.8, 23.5, 26.0, 26.0, 16.2, 22.3, 24.8, 24.8, 16.8, 23.7, 26.0, 26.0, 16.2, 22.5, 25.0, 25.0, 16.8, 23.7, 26.2, 26.2, 16.3, 22.5, 25.0, 25.0),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      ku_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(4.4, 6.4, 7.2, 7.2, 4.8, 6.6, 7.3, 7.3, 4.7, 6.8, 7.6, 7.6, 5.0, 6.9, 7.7, 7.7, 5.0, 7.2, 8.1, 8.1, 5.3, 7.3, 8.1, 8.1, 5.2, 7.5, 8.4, 8.4, 5.5, 7.6, 8.4, 8.4, 5.3, 7.6, 8.5, 8.5, 5.6, 7.8, 8.6, 8.6),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      capl_lookup <- data.frame(
        age = c(rep(8, 8), rep(9, 8), rep(10, 8), rep(11, 8), rep(12, 8)),
        gender = c(rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4), rep("boy", 4), rep("girl", 4)),
        bound = c(47.3, 65.3, 72.7, 72.7, 49.6, 64.8, 71.7, 71.7, 48.8, 67.4, 75.0, 75.0, 50.6, 66.1, 73.1, 73.1, 49.8, 68.7, 76.4, 76.4, 51.2, 66.8, 73.9, 73.9, 50.2, 69.3, 77.1, 77.1, 51.3, 67.0, 74.1, 74.1, 51.6, 71.1, 79.1, 79.1, 52.1, 68.1, 75.3, 75.3),
        interpretation = rep(c("beginning", "progressing", "achieving", "excelling"), 10)
      )
      empty_lookup <- data.frame(age = NA, gender = NA, bound = NA, interpretation = NA)
      age <- validate_age(age)
      gender <- validate_gender(gender)
      score <- validate_number(score)
      if(protocol == "camsa") score <- score * 2.8
      protocol <- as.character(protocol)
      return(
        unname(
          apply(data.frame(age, gender, score, rep(tolower(protocol[1]), length(age))), 1, function(x) {
            age <- validate_age(x[1])
            gender <- validate_gender(x[2])
            score <- validate_number(x[3])
            protocol <- validate_character(x[4])
            if(! is.na(score)) {
              if(protocol == "pacer") {
                score <- validate_scale(score, 1, 229)
              } else if(protocol == "plank") {
                score <- ifelse(score < 0, NA, score)
              } else if(protocol == "camsa") {
                score <- validate_scale(score, 1, 28)
                print(score)
              } else if(protocol == "steps") {
                score <- validate_scale(score, 1000, 30000)
              } else if(protocol == "self_report_pa") {
                score <- validate_scale(score, 0, 7)
              } else if(protocol == "db") {
                score <- validate_scale(score, 0, 30)
              } else {
                # Do nothing
              }
            }
            if(sum(is.na(c(age, gender, score, protocol))) > 0 | ! protocol %in% c("pacer", "plank", "camsa", "pc", "steps", "self_report_pa", "db", "mc", "ku", "capl")) {
              return(NA)
            } else {
              if(protocol == "pacer") {
                lookup <- pacer_lookup
              } else if(protocol == "plank") {
                lookup <- plank_lookup
              } else if(protocol == "camsa") {
                lookup <- camsa_lookup
              } else if(protocol == "pc") {
                lookup <- pc_lookup
              } else if(protocol == "steps") {
                lookup <- steps_lookup
              } else if(protocol == "self_report_pa") {
                lookup <- self_report_pa_lookup
              } else if(protocol == "db") {
                lookup <- db_lookup
              } else if(protocol == "mc") {
                lookup <- mc_lookup
              } else if(protocol == "ku") {
                lookup <- ku_lookup
              } else if(protocol == "capl") {
                lookup <- capl_lookup
              } else {
                lookup <- empty_lookup
              }
              age <- floor(age)
              lookup <- lookup[which(lookup$age == age & lookup$gender == gender),]
              if(score < lookup$bound[lookup$interpretation == "beginning"]) {
                return("beginning")
              } else if(score <= lookup$bound[lookup$interpretation == "progressing"]) {
                return("progressing")
              } else if(score <= lookup$bound[lookup$interpretation == "achieving"]) {
                return("achieving")
              } else if(score > lookup$bound[lookup$interpretation == "excelling"]) {
                return("excelling")
              } else {
                return(NA)
              }
            }
          })
        )
      )
    } else {
      stop("[CAPL error]: the age, gender and score arguments must be the same length.")
    }
  )
}

capl_demo_data$camsa_interpretation <- j(
  age = capl_demo_data$age,
  gender = capl_demo_data$gender,
  score = capl_demo_data$camsa_overall_score,
  protocol = "camsa"
)

k <- validate_number(capl_demo_data$camsa_overall_score)
k <- k * 2.8
k
k <- validate_scale(k, 1, 28)
k

validate_scale <- function(x, lower_bound = NA, upper_bound = NA) {
  x <- validate_integer(x)
  lower_bound <- validate_integer(lower_bound[1])
  upper_bound <- validate_integer(upper_bound[1])
  return(
    unname(
      sapply(x, function(x) {
        if(sum(is.na(c(x, lower_bound, upper_bound))) > 0 | x < lower_bound | x > upper_bound) {
          NA
        } else {
          x
        }
      })
    )
  )
}
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$camsa_interpretation
```

#### Physical competence score

The `get_pc_score()` function computes a physical competence domain score based on the PACER (Progressive Aerobic Cardiovascular Endurance Run), plank and CAMSA (Canadian Agility and Movement Skill Assessment) scores. If one protocol score is missing or invalid, a weighted domain score will be computed from the other two protocol scores. This score is used to compute the physical competence domain score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$pc_score <- get_pc_score(
  pacer_score = capl_demo_data$pacer_score,
  plank_score = capl_demo_data$plank_score,
  camsa_overall_score = capl_demo_data$camsa_overall_score
)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$pc_score
```

#### Physical competence interpretation

The `get_capl_interpretation()` function computes an age- and gender-specific CAPL-2 interpretation for a given CAPL-2 protocol or domain score.

```{r warning = FALSE, message = FALSE}
capl_demo_data$pc_interpretation <- get_capl_interpretation(
  age = capl_demo_data$age,
  gender = capl_demo_data$gender,
  score = capl_demo_data$pc_score,
  protocol = "pc"
)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$pc_interpretation
```

#### Physical competence domain status

The `get_capl_domain_status()` function computes the status ("complete", "missing interpretation", "missing protocol" or "incomplete") of a CAPL domain.

```{r warning = FALSE, message = FALSE}
capl_demo_data$pc_status <- get_capl_domain_status(
  x = capl_demo_data,
  domain = "pc"
)
```

```{r warning = FALSE, message = FALSE}
capl_demo_data$pc_status
```

### Daily behaviour functions

Incomplete.

### Motivation and confidence functions

Incomplete.

### Knowledge and understanding functions

Incomplete.

### Overall physical literacy functions

Incomplete.

## Data visualization

The `capl` R package makes use of the famous `ggplot2` R package to create custom functions that render beautiful plots for visualizing CAPL-2 results.

### Plots

CAPL-2 scores can be grouped by their associated interpretative categories and visualized in a bar plot by calling the `get_score_by_interpretation_plot()` function. The mean score for each interpretative category appears above each bar.

```{r warning = FALSE, message = FALSE, fig.width = 7.25, fig.height = 7.25}
get_score_by_interpretation_plot(
  score = capl_results$pc_score,
  interpretation = capl_results$pc_interpretation,
  x_label = "Interpretation",
  y_label = "Physical competence domain score (/30)"
)
```

The color palette can be customized by setting the `colors` argument.

```{r warning = FALSE, message = FALSE, fig.width = 7.25, fig.height = 7.25}
get_score_by_interpretation_plot(
  score = capl_results$db_score,
  interpretation = capl_results$db_interpretation,
  x_label = "Interpretation",
  y_label = "Daily behaviour domain score (/30)",
  colors = c("#daf7a6", "#ffc300", "#ff5733", "#c70039")
)
```

## Export results

If users want to export their data, the `writexl` R package allows them to export their data to Excel.

First, users must install the `writexl` R package if they haven't done so previously.

```{r warning = FALSE, message = FALSE, eval = FALSE}
# Install the package
install.packages("writexl")
```

Then, they must load the package and call the `write_xlsx()` function.

```{r warning = FALSE, message = FALSE, eval = FALSE}
# Load the package
library(writexl)

# Export object to Excel
write_xlsx(capl_results, "c:/users/joel/desktop/capl_results.xlsx")
```
